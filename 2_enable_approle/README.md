# Configure Vault, Azure, and TFC

This Terraform configuration will handle configuring the Vault server, Azure subscription, and TFC workspace.

## Environment Variables and Terraform Variables

You will need to authenticate to Vault and Azure:

* Vault - use the admin token generated by the HCP Vault cluster deployment.
* Azure - use the Azure CLI to authenticate to the Azure subscription (`az login`).
* TFC - use the Terraform CLI to authenticate (`terraform login`).

We can handle the Vault authentication using environment variables.

```bash
# Set the Vault token as an environment variable
$VAULT_TOKEN=VAULT_TOKEN

# Set the Vault address as an environment variable
$VAULT_ADDR=VAULT_ADDR
```

```PowerShell
$env:VAULT_TOKEN = "VAULT_TOKEN"
$env:VAULT_ADDR = "VAULT_ADDR"
```

## Azure Resources

The configuration is going to create a service principal (`vault-tfc`) for Vault to use with the Azure secrets engine. Vault will dynamically provision service principals for the subscription you have selected through the Azure CLI. The `vault-tfc` service principal will be granter Owner permissions on the current subscription.

## Vault Configuration

The configuration will create the following resources in Vault:

* Azure secrets engine using the current Azure subscription
* Azure secrets engine role `dev-role` with Contributor permissions on the current subscription
* Vault policy called `dev` with permissions to use the `dev-role` role
* AppRole auth backend
* AppRole role with the `dev` policy assigned to it
* AppRole secret for the role

## TFC Configuration

The configuration will create a workspace called `tfc-vault-approle-demo` in your organization. You will need to supply the name of the organization through the `terraform.tfvars` file. The configuration will also populate the workspace with the necessary variables and values to be used with the config found in the `3_use_approle` directory.
